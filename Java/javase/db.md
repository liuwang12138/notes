### 事务

#### 事务处理

- 事务（Transaction）是一个操作序列。这些操作要么都做，要么都不做，是一个不可分割的工作单位，是数据库环境中的逻辑工作单位。
- 事务是为了保证数据库的完整性
- 事务不能嵌套

#### 事务的四个特性：ACID

- **原子性(Atomicity)**：一个原子事务要么完整执行，要么干脆不执行。这意味着，工作单元中的每项任务都必须正确执行。如果有任意一个任务执行失败，则整个工作单元或事务就会被中止。即此前对数据所作的任何修改都将被撤销。如果所有任务都被成功执行，事务就会被提交，即对数据所作的修改将会是永久性的。
- **一致性(Consistency)**：一致性代表了底层数据存储的完整性。它必须由事务系统和应用开发人员共同来保证。事务系统通过保证事务的原子性，隔离性和持久性来满足这一要求；应用开发人员则需要保证数据库有适当的约束（主键，引用完整性等），并且工作单元中所实现的业务逻辑不会导致数据的不一致，即数据预期所表达的现实业务情况不相一致。
- **隔离性(Isolation)**：隔离性意味着事务必须在不干扰其他进程或事务的前提下独立执行。换言之，在事务或工作单元执行完毕之前，其所访问的数据不能受系统其他部分的影响
  - 严格的隔离性会导致效率降低，在某些情况下为了提高程序的执行效率，需要降低隔离的级别

> 隔离级别：从上往下，隔离级别越来越高，意味着数据越来越安全
>
> 1. 读未提交(read uncommitted)：会产生“脏读”问题
> 2. 读已提交(read committed)：不会产生“脏读”问题，但是会产生不可重复读的问题
> 3. 可重复读(repeatable read)
> 4. 序列化(serializable)
>
> 数据不一致的问题：
>
> 	1. 脏读：A未提交事务，但是B会读到A的修改
>  	2. 不可重复读：同一个事务进行两次相同查询会出现数据不一致的问题。
>
> ```sql
> A: start transation;
> B: start transation;
> A: update ...
> B: select ...
> -- B读不到A的修改
> A: commit;
> B: select ...
> --- B读到了A的修改
> ```
>
> 3. 幻读：A提交了事务，但是B没有看到事务，但是在执行语句时会受到A事务的影响
>
> > insert和update会产生幻读，read不会产生幻读
>
> ```sql
> A: start transation;
> B: start transation;
> A: insert into user values (5, '555');
> B: select * from user
> -- B看不到id为5的数据
> B: insert into user values (5, "qqq");
> error: 主键重复
> ```
>
> |          | 脏读 | 不可重复读 | 幻读 |
> | :------: | :--: | :--------: | :--: |
> | 读未提交 |  √   |     √      |  √   |
> | 读已提交 |  ×   |     √      |  √   |
> | 可重复读 |  ×   |     ×      |  √   |
> |  序列化  |      |            |      |

- **持久性(Durability)**：持久性表示在某个事务的执行过程中，对数据所作的所有改动都必须在十五成功结束前保存至某种物理<font color="red">存储设备</font>。这样可以保证，所作的修改在任何系统瘫痪时不至于丢失。

> Question：四个特性中，哪个是最关键的?
>
> ​	所有的特性中都是为了保证数据的一致性，所以一致性是最终的追求。
>
> ​	**事务中的一致性是通过原子性、隔离性、持久性来保证的**